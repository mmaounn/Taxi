generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  PARTNER_ADMIN
  PARTNER_STAFF
  DRIVER
}

enum DriverStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum VehicleStatus {
  ACTIVE
  MAINTENANCE
  DECOMMISSIONED
}

enum CommissionModel {
  PERCENTAGE
  FIXED
  HYBRID
  PER_RIDE
}

enum SettlementStatus {
  DRAFT
  CALCULATED
  APPROVED
  PAID
  DISPUTED
}

enum PayoutStatus {
  PENDING
  TRANSFERRED
  CONFIRMED
}

enum RideSource {
  BOLT
  UBER
  FREENOW
}

enum RideStatus {
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentMethod {
  CASH
  CARD
  IN_APP
}

enum SettlementFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum LineItemType {
  BONUS
  DEDUCTION
}

model User {
  id                 String    @id @default(cuid())
  email              String    @unique
  passwordHash       String
  role               UserRole
  partnerId          String?
  driverId           String?
  languagePreference String    @default("de")
  lastLogin          DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  partner Partner? @relation(fields: [partnerId], references: [id])
  driver  Driver?  @relation(fields: [driverId], references: [id])
}

model Partner {
  id               String  @id @default(cuid())
  companyName      String
  taxId            String?
  address          String?
  bankIban         String?
  bankBic          String?
  bankName         String?
  boltClientId     String?
  boltClientSecret String?
  uberClientId     String?
  uberClientSecret String?
  uberOrgId        String?

  defaultCommissionModel CommissionModel @default(PERCENTAGE)
  defaultCommissionRate  Decimal?        @db.Decimal(5, 2)
  defaultFixedFee        Decimal?        @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users              User[]
  drivers            Driver[]
  vehicles           Vehicle[]
  settlements        Settlement[]
  syncLogs           SyncLog[]
  lineItemTemplates  LineItemTemplate[]
  driverBalances     DriverBalance[]
}

model Driver {
  id                  String              @id @default(cuid())
  partnerId           String
  firstName           String
  lastName            String
  email               String?
  phone               String?
  taxId               String?
  bankIban            String?
  bankBic             String?
  taxiLicenseNumber   String?
  taxiLicenseExpiry   DateTime?
  driversLicenseExpiry DateTime?
  commissionModel     CommissionModel     @default(PERCENTAGE)
  commissionRate      Decimal?            @db.Decimal(5, 2)
  fixedFee            Decimal?            @db.Decimal(10, 2)
  hybridThreshold     Decimal?            @db.Decimal(10, 2)
  perRideFee          Decimal?            @db.Decimal(10, 2)
  settlementFrequency SettlementFrequency @default(WEEKLY)
  status              DriverStatus        @default(ACTIVE)
  boltDriverId        String?
  uberDriverUuid      String?
  freenowDriverId     String?
  vehicleId           String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  partner            Partner              @relation(fields: [partnerId], references: [id])
  vehicle            Vehicle?             @relation(fields: [vehicleId], references: [id])
  settlements        Settlement[]
  rideData           RideData[]
  users              User[]
  lineItemTemplates  LineItemTemplate[]
  driverBalances     DriverBalance[]
}

model Vehicle {
  id                   String        @id @default(cuid())
  partnerId            String
  licensePlate         String
  make                 String?
  model                String?
  year                 Int?
  color                String?
  monthlyRentalCost    Decimal?      @db.Decimal(10, 2)
  insuranceMonthlyCost Decimal?      @db.Decimal(10, 2)
  otherMonthlyCosts    Decimal?      @db.Decimal(10, 2)
  insuranceExpiry      DateTime?
  registrationExpiry   DateTime?
  status               VehicleStatus @default(ACTIVE)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  partner Partner  @relation(fields: [partnerId], references: [id])
  drivers Driver[]
}

model Settlement {
  id          String           @id @default(cuid())
  driverId    String
  partnerId   String
  periodStart DateTime
  periodEnd   DateTime
  status      SettlementStatus @default(DRAFT)

  // Bolt breakdown
  boltGrossRevenue   Decimal? @db.Decimal(10, 2)
  boltCommission     Decimal? @db.Decimal(10, 2)
  boltCashServiceFee Decimal? @db.Decimal(10, 2)
  boltTips           Decimal? @db.Decimal(10, 2)
  boltBonuses        Decimal? @db.Decimal(10, 2)
  boltReimbursements Decimal? @db.Decimal(10, 2)
  boltNetAmount      Decimal? @db.Decimal(10, 2)

  // Uber breakdown
  uberGrossRevenue Decimal? @db.Decimal(10, 2)
  uberServiceFee   Decimal? @db.Decimal(10, 2)
  uberCityFees     Decimal? @db.Decimal(10, 2)
  uberTips         Decimal? @db.Decimal(10, 2)
  uberPromotions   Decimal? @db.Decimal(10, 2)
  uberNetAmount    Decimal? @db.Decimal(10, 2)

  // FreeNow breakdown
  freenowGrossRevenue Decimal? @db.Decimal(10, 2)
  freenowCommission   Decimal? @db.Decimal(10, 2)
  freenowTips         Decimal? @db.Decimal(10, 2)
  freenowBonuses      Decimal? @db.Decimal(10, 2)
  freenowNetAmount    Decimal? @db.Decimal(10, 2)

  // Combined
  totalPlatformNet Decimal? @db.Decimal(10, 2)

  // Line items (bonuses/deductions)
  lineItemsTotal Decimal? @db.Decimal(10, 2)

  // Fleet owner deductions
  partnerCommissionAmount Decimal? @db.Decimal(10, 2)
  vehicleRentalDeduction  Decimal? @db.Decimal(10, 2)
  fuelCostDeduction       Decimal? @db.Decimal(10, 2)
  insuranceDeduction      Decimal? @db.Decimal(10, 2)
  otherDeductions         Json?

  // Cash reconciliation
  cashCollectedByDriver Decimal? @db.Decimal(10, 2)

  // Final
  driverNetEarnings Decimal? @db.Decimal(10, 2)
  payoutAmount      Decimal? @db.Decimal(10, 2)
  payoutStatus      PayoutStatus?
  payoutReference   String?
  payoutDate        DateTime?

  // Metadata
  calculatedAt DateTime?
  approvedAt   DateTime?
  paidAt       DateTime?
  approvedBy   String?
  notes        String?
  pdfUrl       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  driver       Driver               @relation(fields: [driverId], references: [id])
  partner      Partner              @relation(fields: [partnerId], references: [id])
  rideData     RideData[]
  lineItems    SettlementLineItem[]
  driverBalance DriverBalance?

  @@unique([driverId, periodStart, periodEnd])
}

model RideData {
  id                       String        @id @default(cuid())
  driverId                 String
  settlementId             String?
  source                   RideSource
  externalOrderId          String?
  pickupAddress            String?
  dropoffAddress           String?
  distanceKm               Decimal?      @db.Decimal(10, 2)
  startedAt                DateTime?
  completedAt              DateTime?
  fareAmount               Decimal?      @db.Decimal(10, 2)
  paymentMethod            PaymentMethod?
  tipAmount                Decimal?      @db.Decimal(10, 2)
  platformCommissionAmount Decimal?      @db.Decimal(10, 2)
  status                   RideStatus    @default(COMPLETED)
  importedAt               DateTime      @default(now())

  driver     Driver      @relation(fields: [driverId], references: [id])
  settlement Settlement? @relation(fields: [settlementId], references: [id])

  @@unique([source, externalOrderId])
}

model SyncLog {
  id              String     @id @default(cuid())
  partnerId       String
  platform        RideSource
  syncType        String
  recordsImported Int        @default(0)
  errors          Json?
  startedAt       DateTime   @default(now())
  completedAt     DateTime?
  status          String     @default("running")

  partner Partner @relation(fields: [partnerId], references: [id])
}

model SettlementLineItem {
  id            String       @id @default(cuid())
  settlementId  String
  type          LineItemType
  description   String
  amount        Decimal      @db.Decimal(10, 2)
  isAutoApplied Boolean      @default(false)
  templateId    String?
  createdAt     DateTime     @default(now())

  settlement Settlement        @relation(fields: [settlementId], references: [id])
  template   LineItemTemplate? @relation(fields: [templateId], references: [id])
}

model LineItemTemplate {
  id          String       @id @default(cuid())
  partnerId   String
  type        LineItemType
  description String
  amount      Decimal      @db.Decimal(10, 2)
  scope       String       @default("MANUAL") // MANUAL, ALL_DRIVERS, SPECIFIC_DRIVER
  driverId    String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  partner   Partner              @relation(fields: [partnerId], references: [id])
  driver    Driver?              @relation(fields: [driverId], references: [id])
  lineItems SettlementLineItem[]
}

model DriverBalance {
  id              String    @id @default(cuid())
  driverId        String
  partnerId       String
  settlementId    String?   @unique
  periodStart     DateTime
  periodEnd       DateTime
  openingBalance  Decimal   @db.Decimal(10, 2) @default(0)
  settlementNet   Decimal   @db.Decimal(10, 2) @default(0)
  lineItemsTotal  Decimal   @db.Decimal(10, 2) @default(0)
  cashCollected   Decimal   @db.Decimal(10, 2) @default(0)
  payoutMade      Decimal   @db.Decimal(10, 2) @default(0)
  adjustments     Decimal   @db.Decimal(10, 2) @default(0)
  closingBalance  Decimal   @db.Decimal(10, 2) @default(0)
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  driver     Driver      @relation(fields: [driverId], references: [id])
  partner    Partner     @relation(fields: [partnerId], references: [id])
  settlement Settlement? @relation(fields: [settlementId], references: [id])
}
